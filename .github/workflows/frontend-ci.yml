name: ğŸ¨ Frontend CI - React Build & Quality

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'index.html'
      - 'package.json'
      - 'tsconfig.json'
      - 'vite.config.ts'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'index.html'
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: read      # Read repository contents
  actions: write      # Upload artifacts

env:
  NODE_VERSION: '20.x'
  CI: true

jobs:
  # ===========================================
  # JOB 1: Install Dependencies
  # ===========================================
  install:
    name: ğŸ“¥ Install Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install npm dependencies
        run: npm ci
        shell: bash

      - name: âœ… Verify installation
        run: |
          echo "âœ… Dependencies installed successfully"
          npm list --depth=0
        shell: bash

  # ===========================================
  # JOB 2: ESLint - Code Linting
  # ===========================================
  lint:
    name: ğŸ” ESLint & Code Quality
    runs-on: ubuntu-latest
    needs: install
    
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci
        shell: bash

      - name: ğŸ” Run ESLint
        run: npm run lint 2>&1 || true
        shell: bash
        continue-on-error: true

      - name: ğŸ“Š Linting Summary
        run: |
          echo "## ESLint Report" >> $GITHUB_STEP_SUMMARY
          echo "- Target: src/**/*.{ts,tsx,js}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Checked" >> $GITHUB_STEP_SUMMARY
        shell: bash

  # ===========================================
  # JOB 3: TypeScript Type Checking
  # ===========================================
  typecheck:
    name: ğŸ”¬ TypeScript Type Checking
    runs-on: ubuntu-latest
    needs: install
    
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci
        shell: bash

      - name: ğŸ”¬ Run TypeScript compiler
        run: npx tsc --noEmit
        shell: bash

      - name: ğŸ“Š Type Check Results
        if: always()
        run: |
          echo "## TypeScript Type Checking" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration: tsconfig.json" >> $GITHUB_STEP_SUMMARY
          echo "- Strict Mode: Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… No type errors" >> $GITHUB_STEP_SUMMARY
        shell: bash

  # ===========================================
  # JOB 4: Build with Vite
  # ===========================================
  build:
    name: ğŸ—ï¸ Build Frontend (Vite)
    runs-on: ubuntu-latest
    needs: [install, lint, typecheck]
    
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci
        shell: bash

      - name: ğŸ—ï¸ Build frontend
        run: npm run build
        env:
          VITE_API_URL: https://api.serendipity.local
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        shell: bash

      - name: ğŸ“Š Build Output
        run: |
          echo "## Build Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "dist" ]; then
            SIZE=$(du -sh dist | cut -f1)
            FILES=$(find dist -type f | wc -l)
            echo "- Output Directory: dist/" >> $GITHUB_STEP_SUMMARY
            echo "- Total Size: $SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- Files: $FILES" >> $GITHUB_STEP_SUMMARY
            echo "- Status: âœ… Build successful" >> $GITHUB_STEP_SUMMARY
          fi
        shell: bash

      - name: âœ… Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build artifacts not found!"
            exit 1
          fi
          echo "âœ… Build artifacts verified"
        shell: bash

  # ===========================================
  # JOB 5: Publish Build Artifacts
  # ===========================================
  publish-artifacts:
    name: ğŸ“¦ Publish Build Artifacts
    runs-on: ubuntu-latest
    needs: build
    if: success()
    
    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci
        shell: bash

      - name: ğŸ—ï¸ Build frontend
        run: npm run build
        shell: bash

      - name: ğŸ“¦ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_number }}
          path: dist/
          retention-days: 30
          compression-level: 9

      - name: ğŸ“Š Artifact Summary
        run: |
          echo "## ğŸ“¦ Frontend Build Artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build Number: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: frontend-build-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Retention: 30 days" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Ready for deployment" >> $GITHUB_STEP_SUMMARY
        shell: bash

  # ===========================================
  # JOB 6: Workflow Summary
  # ===========================================
  summary:
    name: ğŸ“‹ Frontend CI Summary
    runs-on: ubuntu-latest
    needs: [install, lint, typecheck, build, publish-artifacts]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate Report
        run: |
          echo "# ğŸ¨ Frontend CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Install | ${{ needs.install.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeCheck | ${{ needs.typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publish | ${{ needs.publish-artifacts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pipeline complete" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: ğŸ”” Notify on failure
        if: failure()
        run: |
          echo "âš ï¸ Frontend CI Pipeline failed"
          echo "Check job details above"
        shell: bash
