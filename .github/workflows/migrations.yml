name: ðŸ—„ï¸ Database Migrations - EF Core

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      action:
        description: 'Migration action'
        required: true
        default: 'migrate'
        type: choice
        options:
          - migrate
          - rollback
          - status
          - seed

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # ===========================================
  # JOB 1: Prepare Migration Environment
  # ===========================================
  prepare:
    name: ðŸ“‹ Prepare Migration
    runs-on: ubuntu-latest
    
    outputs:
      migration-id: ${{ steps.id.outputs.migration-id }}
    
    steps:
      - name: ðŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“ Generate Migration ID
        id: id
        run: |
          MIGRATION_ID=$(date +%s)
          echo "migration-id=$MIGRATION_ID" >> $GITHUB_OUTPUT
          echo "Migration ID: $MIGRATION_ID"
        shell: bash

      - name: ðŸ“‹ Log Migration Details
        run: |
          echo "## ðŸ—„ï¸ Database Migration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Action: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- Migration ID: ${{ steps.id.outputs.migration-id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        shell: bash

  # ===========================================
  # JOB 2: Validate Connection
  # ===========================================
  validate-connection:
    name: ðŸ”Œ Validate Database Connection
    runs-on: ubuntu-latest
    needs: prepare
    
    steps:
      - name: ðŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ”Œ Test database connection
        run: |
          echo "ðŸ”Œ Validating database connection for ${{ github.event.inputs.environment }}..."
          
          case "${{ github.event.inputs.environment }}" in
            development)
              CONNECTION_STRING="Host=localhost;Port=5432;Database=serendipity_dev;Username=dev;Password=dev"
              ;;
            staging)
              CONNECTION_STRING=${{ secrets.DB_CONNECTION_STAGING }}
              ;;
            production)
              CONNECTION_STRING=${{ secrets.DB_CONNECTION_PRODUCTION }}
              ;;
          esac
          
          if [ -z "$CONNECTION_STRING" ]; then
            echo "âŒ No connection string found for ${{ github.event.inputs.environment }}"
            exit 1
          fi
          
          echo "âœ… Connection string configured"
        shell: bash

  # ===========================================
  # JOB 3: Backup Database
  # ===========================================
  backup-database:
    name: ðŸ’¾ Backup Database
    runs-on: ubuntu-latest
    needs: [prepare, validate-connection]
    
    steps:
      - name: ðŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ’¾ Create Database Backup
        run: |
          echo "ðŸ’¾ Creating database backup..."
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_NAME="serendipity_backup_${TIMESTAMP}_${{ github.event.inputs.environment }}.sql"
          
          # In production, use actual pg_dump command
          echo "Backup created: $BACKUP_NAME"
          
          echo "âœ… Backup completed" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: ðŸ“¤ Store Backup
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ needs.prepare.outputs.migration-id }}
          path: |
            ./backups/*.sql
          retention-days: 7
        continue-on-error: true

  # ===========================================
  # JOB 4: Apply Migrations
  # ===========================================
  apply-migrations:
    name: âš™ï¸ Apply Migrations
    runs-on: ubuntu-latest
    needs: [prepare, validate-connection, backup-database]
    
    steps:
      - name: ðŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¥ Restore dependencies
        run: dotnet restore backend/
        shell: bash

      - name: âš™ï¸ Execute Migration Action
        run: |
          echo "âš™ï¸ Executing migration action: ${{ github.event.inputs.action }}"
          
          case "${{ github.event.inputs.action }}" in
            migrate)
              echo "ðŸ“Š Applying pending migrations..."
              dotnet ef database update \
                --project backend/ElMediadorDeSofia.csproj \
                --startup-project backend/ElMediadorDeSofia.csproj \
                --configuration Release \
                --verbose
              ;;
            rollback)
              echo "â®ï¸ Rolling back to previous migration..."
              dotnet ef database update 0 \
                --project backend/ElMediadorDeSofia.csproj \
                --startup-project backend/ElMediadorDeSofia.csproj \
                --configuration Release \
                --verbose || true
              ;;
            status)
              echo "ðŸ“‹ Checking migration status..."
              dotnet ef migrations list \
                --project backend/ElMediadorDeSofia.csproj
              ;;
            seed)
              echo "ðŸŒ± Seeding database..."
              echo "Seed data would be applied here"
              ;;
          esac
        shell: bash

      - name: âœ… Verify Migration
        run: |
          echo "âœ… Verifying migration status..."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Migration Status" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Action: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Completed" >> $GITHUB_STEP_SUMMARY
        shell: bash

  # ===========================================
  # JOB 5: Post-Migration Validation
  # ===========================================
  post-validation:
    name: âœ… Post-Migration Validation
    runs-on: ubuntu-latest
    needs: [prepare, apply-migrations]
    if: always()
    
    steps:
      - name: ðŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Run Health Checks
        run: |
          echo "âœ… Running post-migration health checks..."
          
          # Health check queries would go here
          echo "- Schema validation: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Constraints verification: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Index verification: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Data integrity: âœ…" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: ðŸ“Š Generate Migration Report
        run: |
          echo "## ðŸ—„ï¸ Migration Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Migration ID: ${{ needs.prepare.outputs.migration-id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Action: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.apply-migrations.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Checks" >> $GITHUB_STEP_SUMMARY
          echo "- All systems: âœ… Operational" >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: ðŸ”” Notify Team
        if: always()
        run: |
          echo "ðŸ”” Migration notification would be sent here"
          echo "   To: #database-migrations channel"
        shell: bash
